- alias: Trash Pickup Day Changed
  initial_state: true
  hide_entity: true
  trigger:
  - platform: state
    entity_id: input_select.trash_pickup_day
  action:
  - service: mqtt.publish
    data_template:
      topic: "/home/trashpickupday"
      retain: true
      payload: '{{ states.input_select.trash_pickup_day.state }}'

- alias: Recycle Pickup Day Changed
  initial_state: true
  hide_entity: true
  trigger:
    platform: state
    entity_id: input_select.recycle_pickup_day
  action:
    - service: mqtt.publish
      data_template:
        topic: "/home/recyclepickupday"
        retain: true
        payload: '{{ states.input_select.recycle_pickup_day.state }}'

- alias: Recycle Pickup Week Changed
  initial_state: true
  hide_entity: true
  trigger:
    platform: state
    entity_id: input_select.recycle_pickup_week
  action:
    - service: mqtt.publish
      data_template:
        topic: "/home/recyclepickupweek"
        retain: true
        payload: '{{ states.input_select.recycle_pickup_week.state }}'

- alias: Restore Trash Recycle Settings on Startup
  initial_state: true
  hide_entity: true
  trigger:
    platform: homeassistant
    event: start
  action:
    - delay:
        minutes: 1
    - service: input_select.select_option
      data_template:
        entity_id: input_select.trash_pickup_day
        option: "{{states.sensor.trash_pickup_day.state}}"
    - service: input_select.select_option
      data_template:
        entity_id: input_select.recycle_pickup_day
        option: "{{states.sensor.recycle_pickup_day.state}}"
    - service: input_select.select_option
      data_template:
        entity_id: input_select.recycle_pickup_week
        option: "{{states.sensor.recycle_pickup_week.state}}"

###############################################################################
#  Reminder code - Reminds 5 times every hour starting 4 PM
#  Conditions: Only notifies when someone is at home
###############################################################################
- alias: Trash and Recycle Pickup Reminder
  initial_state: true
  hide_entity: true
  trigger:
    - platform: time
      at: '16:00:00'
    - platform: time
      at: '17:00:00'
    - platform: time
      at: '18:00:00'
    - platform: time
      at: '19:00:00'
    - platform: time
      at: '20:00:00'
    - platform: time
      at: '21:00:00'
  condition:
    condition: and
    conditions:
    - condition: template
      value_template: '{{ states.input_boolean.trash_reminders.state == "on" }}'
    - condition: or
      conditions:
        - condition: state
          entity_id: sensor.trash_day
          state: 'yes'
        - condition: state
          entity_id: sensor.recycle_day
          state: 'yes'
  action:
    - service: notify.trent
      data_template:
        title: >
          {% if is_state("sensor.trash_day", "yes") and is_state("sensor.recycle_day", "yes") %}
            Trash and Recycle Pickup Tomorrow!
          {% elif states.sensor.trash_day.state == "yes" %}
            Trash Pickup Tomorrow!
          {% elif states.sensor.recycle_day.state == "yes" %}
            Recycle Pickup Tomorrow!
          {% endif %}
        message: >
          {% if is_state("sensor.trash_day", "yes") and is_state("sensor.recycle_day", "yes") %}
            Please leave trash and recycle bin outside tonight. Thank you!
          {% elif states.sensor.trash_day.state == "yes" %}
            Please leave trash bin outside tonight. Thank you!
          {% elif states.sensor.recycle_day.state == "yes" %}
            Please leave recycle bin outside tonight. Thank you!
          {% endif %}
        data:
          actions:
          - action: TRASH_LEFT
            title: Done
          - action: TRASH_REMIND_LATER
            title: Remind Later
    - service: script.speech_processing
      data_template:
        speech_message: >
          {% if is_state("sensor.trash_day", "yes") and is_state("sensor.recycle_day", "yes") %}
            Attention!: Tomorrow is the Trash and Recycle Pickup day.
            Please don't forget to put the trash and recycle bin outside tonight!
          {% elif states.sensor.trash_day.state == "yes" %}
            Please don't forget to put the Trash bin outside tonight!
          {% elif states.sensor.recycle_day.state == "yes" %}
            Attention!: Tomorrow is the Recycle Pickup day.
            Please don't forget to put the recycle bin outside tonight!
          {% endif %}
- alias: Trash and Recycle Bin Left Outside Already
  initial_state: true
  hide_entity: true
  trigger:
    platform: event
    event_type: html5_notification.clicked
    event_data:
      action: TRASH_LEFT
  action:
    - service: notify.trent
      data:
        message: "Great job, Thank you!"
    - service: input_boolean.turn_off
      entity_id: input_boolean.trash_reminders

- alias: Remind later
  initial_state: true
  hide_entity: true
  trigger:
    platform: event
    event_type: html5_notification.clicked
    event_data:
      action: TRASH_REMIND_LATER
  action:
    - service: notify.trent
      data:
        message: "Will remind you again in an hour!"
    - service: input_boolean.turn_on
      entity_id: input_boolean.trash_reminders

- alias: Reset Trash Reminders
  initial_state: true
  hide_entity: true
  trigger:
    - platform: time
      at: '09:00:00'
  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.trash_reminders
    - service: input_select.select_option
      data_template:
        entity_id: input_select.trash_pickup_day
        option: "{{states.sensor.trash_pickup_day.state}}"
    - service: input_select.select_option
      data_template:
        entity_id: input_select.recycle_pickup_day
        option: "{{states.sensor.recycle_pickup_day.state}}"
    - service: input_select.select_option
      data_template:
        entity_id: input_select.recycle_pickup_week
        option: "{{states.sensor.recycle_pickup_week.state}}"